<?xml version="1.0"?>
<!--
Build file for Apache Ant (http://ant.apache.org/)

$Id$
$Source$
-->

<project name="GoGui" default="all">

<tstamp/>

<property file="build.properties"/>

<property environment="env"/>

<property name="docbook_xsl" value="external/docbook/docbook-xsl-1.68.1"/>

<property name="scripts" value="
 gogui
 gtpdisplay
 gtpregress
 gtpterminal
 sgftotex
 gmptogtp
 gtpadapter
 gtpdummy
 gtpserver
 netgtp
 twogtp
"/>

<available property="xsl-available" file="${docbook_xsl}/html/chunk.xsl"/>

<available property="comm-available"
 file="external/javacomm/commapi/comm.jar"/>

<condition property="notDistSettings">
<not>
<and>
<istrue value="${optimize}"/>
<isfalse value="${debug}"/>
</and>
</not>
</condition>

<target name="all" depends="
 gmptogtp.jar,
 gogui.jar,
 gtpadapter.jar,
 gtpdisplay.jar,
 gtpdummy.jar,
 gtpregress.jar,
 gtpserver.jar,
 gtpterminal.jar,
 netgtp.jar,
 sgftotex.jar,
 twogtp.jar
"/>

<target name="clean" depends="clean-build-dir">
<delete failonerror="false" includeEmptyDirs="true">
<fileset dir="lib"
 includes="
   gmptogtp.jar,
   gogui.jar,
   gtpadapter.jar,
   gtpdisplay.jar,
   gtpdummy.jar,
   gtpregress.jar,
   gtpserver.jar,
   gtpterminal.jar,
   netgtp.jar,
   sgftotex.jar,
   twogtp.jar
  "
/>
</delete>
</target>

<target name="clean-build-dir">
<delete failonerror="false" includeEmptyDirs="true">
<fileset dir="build/config"/>
<fileset dir="build/depcache"/>
<fileset dir="build/depcache-test"/>
<fileset dir="build/doc"/>
<fileset dir="build/game"/>
<fileset dir="build/gmp"/>
<fileset dir="build/gmptogtp"/>
<fileset dir="build/go"/>
<fileset dir="build/gtp"/>
<fileset dir="build/gtpadapter"/>
<fileset dir="build/gtpdisplay"/>
<fileset dir="build/gtpdummy"/>
<fileset dir="build/gtpregress"/>
<fileset dir="build/gtpserver"/>
<fileset dir="build/gtpterminal"/>
<fileset dir="build/gogui"/>
<fileset dir="build/gui"/>
<fileset dir="build/images"/>
<fileset dir="build/latex"/>
<fileset dir="build/netgtp"/>
<fileset dir="build/sgf"/>
<fileset dir="build/sgftotex"/>
<fileset dir="build/test"/>
<fileset dir="build/twogtp"/>
<fileset dir="build/utils"/>
<fileset dir="build/version"/>
<fileset dir="build/GoGui.app"/>
<fileset dir="build" includes="GoGui*.dmg"/>
</delete>
</target>

<target name="compile" depends="extract-comm.jar,depend,version,doc">
<mkdir dir="build"/>
<javac srcdir="src" destdir="build" source="1.4" target="1.4"
 deprecation="true" optimize="${optimize}" debug="${debug}" listfiles="yes"
 classpath="external/javacomm/commapi/comm.jar"/>
<copy todir="build">
<fileset dir="src" includes="images/*.png"/>
</copy>
<copy todir="build/doc">
<fileset dir="doc/html" includes="*.html *.css *.png"/>
</copy>
<copy todir="build/config">
<fileset dir="config" includes="analyze-commands"/>
</copy>
</target>

<target name="depend">
<depend srcdir="src" destdir="build" cache="build/depcache"/>
</target>

<target name="dist" depends="all,docvalidate,test,man">
<fail if="notDistSettings" message="Not dist settings in build.properties"/>
<zip destfile="gogui-${version}.zip">
<zipfileset prefix="gogui-${version}" dir="." includes="
 README
 INSTALL
 TODO
 build.properties
 build.xml
 config/analyze-commands*
 config/gogui*.desktop
 config/gogui.omf
 config/gogui.xml
 doc/html/*.html
 doc/html/*.png
 doc/html/*.css
 doc/man/*.1
 doc/xml/*.xml
 doc/xml/*.xml.in
 doc/xml/*.xsl
 doxygen/Doxyfile
 doxygen/footer.html
 doxygen/README
 ${docbook_xsl}.zip
 external/javacomm/javacomm20-win32.zip
 external/javacomm/README
 lib/*.jar
 mac/packaging/GoGui.icns
 mac/packaging/Info.plist
 mac/packaging/Info.plist.in
 mac/packaging/PkgInfo
 mac/src/specialmac/RegisterSpecialMacHandler.java
 mac/src/specialmac/RegisterSpecialMacHandler.class
 mac/src/specialmac/Listener.class  
 sgf/openings/9x9/README
 sgf/openings/9x9/*.sgf
 sgf/openings/19x19/README
 sgf/openings/19x19/*.sgf
 src/images/*.png
 src/overview.html
 src/*/package.html
 src/*/*.java
 src/*/*.java.in
 test/*/*.java
" />
<zipfileset prefix="gogui-${version}" dir="." filemode="755" includes="
 install.sh,
 bin/gmptogtp,
 bin/gogui,
 bin/gtpadapter,
 bin/gtpdisplay,
 bin/gtpdummy,
 bin/gtpregress,
 bin/gtpserver,
 bin/gtpterminal,
 bin/netgtp,
 bin/sgftotex,
 bin/twogtp,
" />
</zip>
</target>

<target name="doc" depends="extract-docbook,doc-check-uptodate"
 unless="doc-uptodate"
 description="Generate documentation using xsltproc">
<echo message="Running xsltproc"/>
<exec executable="xsltproc">
<arg line="--path ${docbook_xsl}/html"/>
<arg line="-o doc/html/"/>
<arg line="doc/xml/custom.xsl"/>
<arg line="doc/xml/book.xml"/>
</exec>
<!-- Remove empty div sections that create unwanted space in JEditorPane -->
<replace dir="doc/html" includes="*.html" token="&lt;div&gt;&lt;/div&gt;"
 encoding="UTF-8"/>
<copy todir="doc/html">
<fileset dir="src/images" includes="project-support.png"/>
</copy>
</target>

<target name="doc-style" depends="extract-docbook,doc-check-uptodate"
 unless="doc-uptodate"
 description="
Generate documentation using ant style target.
Not used at present due to problems with mdash in output (not understood
by JEditorPane, slow speed and errors with old versions of Xalan).">
<style basedir="doc/xml" includes="book.xml" destdir="doc/html"
 style="${docbook_xsl}/html/chunk.xsl" force="true">
<xmlcatalog>
<dtd
 publicId="http://docbook.sourceforge.net/release/xsl/current/html/chunk.xsl"
 location="${docbook_xsl}/html/chunk.xsl"/>
</xmlcatalog>
</style>
<copy todir="doc/html">
<fileset dir="src/images" includes="project-support.png"/>
</copy>
</target>

<target name="docvalidate">
<xmlvalidate file="doc/xml/book.xml"/>
</target>

<target name="doc-check-uptodate">
<uptodate property="doc-uptodate" targetfile="doc/html/index.html">
<srcfiles dir= "doc/xml" includes="*.xml"/>
<srcfiles dir= "doc/xml" includes="*.xsl"/>
<srcfiles dir= "doc/html" includes="*.css"/>
</uptodate>
</target>

<target name="doxygen"
 description="Generate source code documentation using doxygen">
<exec executable="doxygen" dir="doxygen"/>
</target>

<target name="extract-comm.jar" unless="comm-available">
<unzip src="external/javacomm/javacomm20-win32.zip" dest="external/javacomm">
<patternset>
<include name="commapi/comm.jar"/>
</patternset>
</unzip>
</target>

<target name="extract-docbook" unless="xsl-available">
<unzip src="${docbook_xsl}.zip" dest="external/docbook"/>
</target>

<target name="gmptogtp.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gmptogtp.jar">
<manifest>
<attribute name="Main-Class" value="gmptogtp.Main"/>
</manifest>
<fileset dir="build" includes="
 gmp/*.class
 gmptogtp/*.class
 go/Color.class
 go/Point.class
 gtp/*.class
 gtp/ReadThread.class
 utils/ErrorMessage.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/StreamCopy.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gogui.app" depends="gogui.jar"
 description="Make Mac application bundle">
<property name="appdir" value="build/GoGui.app"/>
<mkdir dir="${appdir}"/>
<mkdir dir="${appdir}/Contents"/>
<mkdir dir="${appdir}/Contents/bin"/>
<mkdir dir="${appdir}/Contents/MacOS"/>
<mkdir dir="${appdir}/Contents/Resources"/>
<mkdir dir="${appdir}/Contents/Resources/Java"/>
<copy file="/System/Library/Frameworks/JavaVM.framework/Versions/Current/Resources/MacOS/JavaApplicationStub"
  todir="${appdir}/Contents/MacOS"/>
<exec executable="chmod">
<arg line="755 ${appdir}/Contents/MacOS/JavaApplicationStub"/>
</exec>
<copy todir="${appdir}/Contents" overwrite="true">
<fileset dir="mac/packaging" includes="Info.plist PkgInfo"/>
</copy>
<copy todir="${appdir}/Contents/Resources" overwrite="true">
<fileset dir="mac/packaging" includes="GoGui.icns"/>
</copy>
<copy todir="${appdir}/Contents/Resources/GoGui Help" overwrite="true">
<fileset dir="doc/html" includes="*.html *.css *.png"/>
</copy>
<replace file="${appdir}/Contents/Resources/GoGui Help/index.html"
 token="&lt;head&gt;"
 value="&lt;head&gt;&lt;meta name=&quot;AppleTitle&quot; content=&quot;GoGui Help&quot;&gt;"/>
<copy todir="${appdir}/Contents/Resources/Java" overwrite="true">
<fileset dir="lib" includes="*.jar"/>
</copy>
<copy todir="${appdir}/Contents/bin" overwrite="true">
<fileset dir="bin" includes="${scripts}"/>
</copy>
<replace dir="${appdir}/Contents/bin" includes="${scripts}"
 token="/../lib" value="/../Resources/Java"/>
<chmod dir="${appdir}/Contents/bin" includes="${scripts}" perm="755"/>
<exec executable="/Developer/Tools/SetFile">
<arg line="-a B ${appdir}"/>
</exec>
</target>

<target name="gogui.dmg" depends="gogui.app"
 description="Make Mac compressed disk image">
<exec executable="hdiutil">
<arg line="create -fs HFS+ -format UDZO -volname GoGui-${version} -srcfolder build/GoGui.app build/GoGui-${version}.dmg"/>
</exec>
</target>

<target name="gogui.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gogui.jar">
<manifest>
<attribute name="Main-Class" value="gogui.SplashScreen"/>
</manifest>
<fileset dir="build" includes="
 config/analyze-commands
 doc/*.html
 doc/*.png
 doc/*.css
 game/*.class
 go/*.class
 gtp/*.class
 gogui/*.class
 gui/*.class
 images/*.png
 latex/*.class
 sgf/*.class
 utils/*.class
 version/Version.class
"/>
<fileset dir="mac/src" includes="
 specialmac/*.class
"/>
</jar>
</target>

<target name="gtpadapter.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpadapter.jar">
<manifest>
<attribute name="Main-Class" value="gtpadapter.Main"/>
</manifest>
<fileset dir="build" includes="
 game/*.class
 go/*.class
 gtp/*.class
 gtpadapter/*.class
 sgf/*.class
 utils/ErrorMessage.class
 utils/MessageQueue.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/ProgressShow*.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gtpdisplay.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpdisplay.jar">
<manifest>
<attribute name="Main-Class" value="gtpdisplay.Main"/>
</manifest>
<fileset dir="build" includes="
 game/*.class
 go/*.class
 gui/Board*.class
 gui/BoardLabel.class
 gui/Field*.class
 gui/GuiUtils.class
 gui/SimpleDialogs.class
 gtp/*.class
 gtpdisplay/*.class
 images/gogui*.png
 images/wood.png
 latex/Filter.class
 sgf/Filter.class
 utils/ErrorMessage.class
 utils/MessageQueue.class
 utils/Platform.class
 utils/Options.class
 utils/RadialGradient*.class
 utils/SquareLayout.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gtpdummy.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpdummy.jar">
<manifest>
<attribute name="Main-Class" value="gtpdummy.Main"/>
</manifest>
<fileset dir="build" includes="
 go/Color.class
 go/Move.class
 go/Point.class
 gtp/*.class
 gtpdummy/*.class
 utils/ErrorMessage.class
 utils/Options.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gtpregress.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpregress.jar">
<manifest>
<attribute name="Main-Class" value="gtpregress.Main"/>
</manifest>
<fileset dir="build" includes="
 go/Color.class
 go/Move.class
 go/Point.class
 gtp/*.class
 gtpregress/*.class
 utils/ErrorMessage.class
 utils/FileUtils.class
 utils/MessageQueue.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gtpserver.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpserver.jar">
<manifest>
<attribute name="Main-Class" value="gtpserver.GtpServer"/>
</manifest>
<fileset dir="build" includes="
 gtpserver/*.class
 utils/ErrorMessage.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/StreamCopy.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="gtpterminal.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/gtpterminal.jar">
<manifest>
<attribute name="Main-Class" value="gtpterminal.Main"/>
</manifest>
<fileset dir="build" includes="
 game/*.class
 go/*.class
 gtp/*.class
 gtpterminal/*.class
 sgf/*.class
 utils/ErrorMessage.class
 utils/FileUtils.class
 utils/MessageQueue.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/ProgressShow*.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="javadoc"
 description="Create Javadoc documentation for public parts of packages">
<javadoc sourcepath="src" destdir="javadoc" source="1.4"
 windowtitle="GoGui Source Documentation"
 overview="src/overview.html"
 packagenames="
  game.*,
  gmp.*,
  gmptogtp.*,
  go.*,
  gogui.*,
  gtp.*,
  gtpadapter.*,
  gtpdisplay.*,
  gtpdummy.*,
  gtpregress.*,
  gtpserver.*,
  gtpterminal.*,
  gui.*,
  latex.*,
  netgtp.*,
  sgf.*,
  sgftotex.*,
  twogtp.*,
  utils.*,
  version.*
">
<tag name="bug" scope="all" description="Bugs:"/>
<tag name="todo" scope="all" description="To do:"/>
</javadoc>
</target>

<target name="man" depends="extract-docbook">
<exec executable="xsltproc">
<arg line="--param chunk.quietly 1"/>
<arg line="-o doc/man/"/>
<arg line="${docbook_xsl}/manpages/docbook.xsl"/>
<arg line="doc/xml/reference-gmptogtp.xml"/>
<arg line="doc/xml/reference-gogui.xml"/>
<arg line="doc/xml/reference-gtpadapter.xml"/>
<arg line="doc/xml/reference-gtpdisplay.xml"/>
<arg line="doc/xml/reference-gtpdummy.xml"/>
<arg line="doc/xml/reference-gtpregress.xml"/>
<arg line="doc/xml/reference-gtpserver.xml"/>
<arg line="doc/xml/reference-gtpterminal.xml"/>
<arg line="doc/xml/reference-netgtp.xml"/>
<arg line="doc/xml/reference-sgftotex.xml"/>
<arg line="doc/xml/reference-twogtp.xml"/>
</exec>
</target>

<target name="netgtp.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/netgtp.jar">
<manifest>
<attribute name="Main-Class" value="netgtp.NetGtp"/>
</manifest>
<fileset dir="build" includes="
 netgtp/*.class
 utils/ErrorMessage.class
 utils/Options.class
 utils/StreamCopy.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="sgftotex.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/sgftotex.jar">
<manifest>
<attribute name="Main-Class" value="sgftotex.SgfToTex"/>
</manifest>
<fileset dir="build" includes="
 game/*.class
 go/*.class
 latex/*.class
 sgf/*.class
 sgftotex/*.class
 utils/ErrorMessage.class
 utils/FileUtils.class
 utils/Options.class
 utils/ProgressShow*.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="specialmac" depends="compile"
 description="Compile special MAC classes depending on com.apple">
<javac srcdir="mac/src" source="1.4" deprecation="true" classpath="build"
 optimize="true" listfiles="yes"
 includes="specialmac/RegisterSpecialMacHandler.java"/>
</target>

<target name="tags"
 description="Build a TAGS file for Emacs" >
<exec executable="sh">
<arg line="-c 'etags `find src -name &quot;*.java&quot;`'" />
</exec>
</target>

<target name="test" depends="test-compile"
 description="Run JUnit tests" >
<junit printsummary="withOutAndErr" fork="true" timeout="10000"
 haltonfailure="true">
<classpath>
<pathelement location="build"/>
<pathelement location="build/test"/>
</classpath>
<formatter type="brief" usefile="false"/>
<batchtest todir="build">
<fileset dir="build/test" includes="**/*Test.class"/>
</batchtest>
</junit>
</target>

<target name="test-compile" depends="compile,test-depend">
<mkdir dir="build/test"/>
<javac srcdir="test" destdir="build/test" source="1.4" target="1.4"
 deprecation="true" optimize="${optimize}" debug="${debug}" listfiles="yes"
 classpath="build"/>
<copy todir="build/test">
<fileset dir="test" includes="sgf/*.sgf"/>
</copy>
</target>

<target name="test-depend">
<depend srcdir="test" destdir="build/test" cache="build/depcache-test"/>
</target>

<target name="twogtp.jar" depends="compile">
<mkdir dir="lib"/>
<jar destfile="lib/twogtp.jar">
<manifest>
<attribute name="Main-Class" value="twogtp.Main"/>
</manifest>
<fileset dir="build" includes="
 game/*.class
 go/*.class
 gtp/*.class
 sgf/*.class
 twogtp/*.class
 utils/ErrorMessage.class
 utils/FileUtils.class
 utils/MessageQueue.class
 utils/Options.class
 utils/ProcessUtils*.class
 utils/ProgressShow*.class
 utils/StringUtils.class
 version/Version.class
"/>
</jar>
</target>

<target name="version" depends="version-check-uptodate"
 unless="version-uptodate">
<copy
file="src/version/Version.java.in"
tofile="src/version/Version.java" overwrite="true"/>
<replace file="src/version/Version.java" token="@VERSION@"
 value="${version}"/>
<copy
 file="doc/xml/version.xml.in"
 tofile="doc/xml/version.xml" overwrite="true"/>
<replace file="doc/xml/version.xml" token="@VERSION@" value="${version}"/>
<copy
 file="mac/packaging/Info.plist.in"
 tofile="mac/packaging/Info.plist" overwrite="true"/>
<replace file="mac/packaging/Info.plist" token="@VERSION@"
 value="${version}"/>
</target>

<target name="version-check-uptodate">
<uptodate property="version-uptodate" targetfile="src/version/Version.java">
<srcfiles dir="."
 includes="
  build.properties,
  doc/xml/version.xml.in,
  mac/packaging/Info.plist.in,
  src/version/Version.java.in,
"/>
</uptodate>
</target>

</project>
